<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Library App</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { margin: 5px; }
    .book-container { display: flex; flex-wrap: wrap; gap: 10px; }
    .book-card {
      border: 1px solid #ccc;
      padding: 10px;
      width: 200px;
      border-radius: 5px;
      box-shadow: 2px 2px 5px #ddd;
      position: relative;
    }
    .overdue { color: red; }
    .dialogue {
      position: fixed;
      top: 50%;
      left: 50%;
      background: white;
      border: 1px solid #aaa;
      padding: 20px;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 10px #0003;
      z-index: 999;
    }
    .overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 998;
    }
  </style>
</head>
<body>
  <h1>Library</h1>
  <input id="bookName" placeholder="Enter book name" />
  <button onclick="addBook()">Submit</button>

  <h2>Taken Books</h2>
  <div id="takenBooks" class="book-container"></div>

  <h2>Returned Books</h2>
  <div id="returnedBooks" class="book-container"></div>

  <div id="dialogueContainer" style="display: none;">
    <div class="overlay" onclick="closeDialogue()"></div>
    <div class="dialogue" id="dialogueBox"></div>
  </div>

  <script>
    async function fetchBooks() {
      const takenRes = await fetch('/books');
      const returnedRes = await fetch('/books/returned');
      const takenBooks = await takenRes.json();
      const returnedBooks = await returnedRes.json();

      const takenDiv = document.getElementById('takenBooks');
      takenDiv.innerHTML = '';
      takenBooks.forEach(book => {
        const takenOn = new Date(book.taken_on);
        const dueDate = new Date(takenOn);
        dueDate.setDate(dueDate.getDate() + 1);
        const now = new Date();
        const isOverdue = now > dueDate;
        const fine = isOverdue ? Math.ceil((now - dueDate) / (1000 * 60 * 60 * 24)) * 10 : 0;

        const card = document.createElement('div');
        card.className = 'book-card';

        card.innerHTML = `
          <b>${book.name}</b><br>
          <small>Taken on: ${takenOn.toLocaleString()}</small><br>
          <small>Due by: ${dueDate.toLocaleString()}</small><br>
          ${isOverdue ? `<div class="overdue">Fine: ₹${fine}</div>` : ''}
          <button onclick="handleReturn(${book.id}, ${fine})">Return</button>
        `;

        takenDiv.appendChild(card);
      });

      const returnedDiv = document.getElementById('returnedBooks');
      returnedDiv.innerHTML = '';
      returnedBooks.forEach(book => {
        returnedDiv.innerHTML += `
          <div class="book-card">
            <small>Book Name: ${book.name}<small><br>
            <small>Taken on: ${new Date(book.taken_on).toLocaleString()}</small><br>
            <small>Returned on: ${new Date(book.returned_on).toLocaleString()}</small><br>
            Fine Paid: ₹${book.fine || 0}
          </div>
        `;
      });
    }

    async function addBook() {
      const name = document.getElementById("bookName").value;
      if (!name) return alert("Enter book name");
      await fetch('/books', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name }),
      });
      document.getElementById("bookName").value = '';
      fetchBooks();
    }

    function handleReturn(id, fine) {
      if (fine > 0) {
        showDialogue(`You need to pay ₹${fine} fine to return this book. <br><br>
          <button onclick="returnBook(${id})">Pay Fine & Return</button>
          <button onclick="closeDialogue()">Cancel</button>`);
      } else {
        returnBook(id);
      }
    }

    async function returnBook(id) {
      await fetch(`/books/${id}/return`, { method: "PUT" });
      closeDialogue();
      fetchBooks();
    }

    function showDialogue(content) {
      document.getElementById("dialogueBox").innerHTML = content;
      document.getElementById("dialogueContainer").style.display = 'block';
    }

    function closeDialogue() {
      document.getElementById("dialogueContainer").style.display = 'none';
    }

    fetchBooks();
  </script>
</body>
</html>
